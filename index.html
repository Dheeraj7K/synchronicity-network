<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collective Synchronicity Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            display: flex;
            color: white;
            overflow: hidden;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .right-panel {
            width: 350px;
            background: rgba(10, 14, 39, 0.95);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            padding: 20px;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 0.95em;
            opacity: 0.8;
        }

        #globeContainer {
            flex: 1;
            position: relative;
            background: radial-gradient(ellipse at center, #1a1f4d 0%, #0a0e27 100%);
            border-radius: 10px;
            margin: 20px;
            min-height: 500px;
        }

        .pulse-button-container {
            text-align: center;
            padding: 20px;
        }

        .pulse-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
        }

        .pulse-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(245, 87, 108, 0.6);
        }

        .pulse-button.pulsing {
            animation: pulse 0.6s ease-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
            }
            50% {
                transform: scale(1.2);
                box-shadow: 0 0 0 30px rgba(245, 87, 108, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #f5576c;
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }

        .timeline-section {
            padding: 20px;
            flex: 1;
        }

        .timeline-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-graph {
            height: 200px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 10px;
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-bar {
            position: absolute;
            bottom: 10px;
            width: 3px;
            background: linear-gradient(to top, #f5576c, #f093fb);
            border-radius: 2px;
            transition: height 0.3s ease;
            cursor: pointer;
        }

        .timeline-bar:hover {
            background: #f5576c;
            width: 5px;
        }

        .synchronized-moments {
            max-height: 300px;
            overflow-y: auto;
        }

        .moment-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .moment-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #f5576c;
        }

        .moment-item.active {
            background: rgba(245, 87, 108, 0.2);
            border-left-color: #f5576c;
        }

        .moment-time {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .moment-count {
            font-size: 1.2em;
            color: #f5576c;
            margin-bottom: 3px;
        }

        .moment-locations {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 5px;
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 8px;
            margin: 10px 20px;
            font-size: 0.9em;
        }

        .connection-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .location-permission {
            text-align: center;
            padding: 10px;
            background: rgba(255, 193, 7, 0.2);
            border-radius: 8px;
            margin: 10px 20px;
            font-size: 0.85em;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
                overflow-y: auto;
            }

            .left-panel {
                padding: 10px;
                overflow-y: visible;
            }

            .right-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .header {
                padding: 15px 10px;
            }

            h1 {
                font-size: 1.5em;
            }

            .subtitle {
                font-size: 0.85em;
            }

            #globeContainer {
                min-height: 300px;
                margin: 10px;
            }

            .pulse-button-container {
                padding: 15px;
            }

            .pulse-button {
                width: 120px;
                height: 120px;
                font-size: 1em;
            }

            .stats-grid {
                padding: 15px;
                gap: 8px;
            }

            .stat-box {
                padding: 10px;
            }

            .stat-number {
                font-size: 1.5em;
            }

            .stat-label {
                font-size: 0.75em;
            }

            .timeline-section {
                padding: 15px;
            }

            .timeline-title {
                font-size: 1em;
            }

            .timeline-graph {
                height: 120px;
            }

            .synchronized-moments {
                max-height: 200px;
            }

            .connection-status, .location-permission {
                margin: 10px 15px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.3em;
            }

            .subtitle {
                font-size: 0.8em;
            }

            .pulse-button {
                width: 100px;
                height: 100px;
                font-size: 0.9em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                padding: 10px;
            }

            .stat-number {
                font-size: 1.3em;
            }

            .timeline-graph {
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <div class="header">
            <h1>üåç Collective Synchronicity Network</h1>
            <p class="subtitle">Send a pulse when you experience synchronicity. See who else felt it at the same moment.</p>
        </div>

        <div id="globeContainer"></div>

        <div class="pulse-button-container">
            <button class="pulse-button" id="pulseBtn">
                SEND<br>PULSE
            </button>
        </div>
    </div>

    <div class="right-panel">
        <div class="connection-status">
            <span class="connection-indicator"></span>
            <span>Connected to Global Network</span>
        </div>

        <div id="locationPermission" class="location-permission" style="display: none;">
            üìç Click "Allow" to share your location
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-number" id="yourPulses">0</div>
                <div class="stat-label">Your Pulses</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="globalPulses">0</div>
                <div class="stat-label">Today's Pulses</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="peopleSynced">0</div>
                <div class="stat-label">Synced With You</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="connectedUsers">1</div>
                <div class="stat-label">Online Now</div>
            </div>
        </div>

        <div class="timeline-section">
            <div class="timeline-title">üìä Synchronicity Timeline</div>
            <div class="timeline-graph" id="timelineGraph"></div>

            <div class="timeline-title">‚ö° Synchronized Moments</div>
            <div class="synchronized-moments" id="syncedMoments">
                <div style="text-align: center; opacity: 0.5; padding: 20px; font-size: 0.9em;">
                    Send a pulse to start tracking synchronized moments
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const SOCKET_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001' 
            : 'YOUR_BACKEND_URL_HERE';
        
        let socket;
        let scene, camera, renderer, globe, pulseMarkers = [];
        let yourPulsesCount = 0;
        let globalPulsesCount = 0;
        let pulseHistory = [];
        let timelineBuckets = new Array(60).fill(0);
        let userLocation = null;
        let activeMomentId = null;

        const yourPulsesEl = document.getElementById('yourPulses');
        const globalPulsesEl = document.getElementById('globalPulses');
        const peopleSyncedEl = document.getElementById('peopleSynced');
        const connectedUsersEl = document.getElementById('connectedUsers');
        const syncedMomentsEl = document.getElementById('syncedMoments');
        const timelineGraphEl = document.getElementById('timelineGraph');
        const pulseBtn = document.getElementById('pulseBtn');

        function initGlobe() {
            const container = document.getElementById('globeContainer');
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 300;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setClearColor(0x000000, 0);
            container.appendChild(renderer.domElement);

            const geometry = new THREE.SphereGeometry(100, 64, 64);
            const material = new THREE.MeshBasicMaterial({
                color: 0x1a4d8f,
                wireframe: true,
                transparent: true,
                opacity: 0.3
            });
            globe = new THREE.Mesh(geometry, material);
            scene.add(globe);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            globe.rotation.y += 0.001;
            
            pulseMarkers.forEach(marker => {
                if (marker.scale.x > 0.1) {
                    marker.scale.x *= 0.98;
                    marker.scale.y *= 0.98;
                    marker.scale.z *= 0.98;
                    marker.material.opacity *= 0.98;
                } else {
                    scene.remove(marker);
                }
            });
            pulseMarkers = pulseMarkers.filter(m => m.scale.x > 0.1);

            renderer.render(scene, camera);
        }

        function addPulseToGlobe(lat, lon, isYours = false) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            const radius = 102;

            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const y = radius * Math.cos(phi);
            const z = radius * Math.sin(phi) * Math.sin(theta);

            const geometry = new THREE.SphereGeometry(3, 16, 16);
            const material = new THREE.MeshBasicMaterial({
                color: isYours ? 0x00ff00 : 0xff0066,
                transparent: true,
                opacity: 1
            });
            const marker = new THREE.Mesh(geometry, material);
            marker.position.set(x, y, z);
            scene.add(marker);
            pulseMarkers.push(marker);

            const ringGeo = new THREE.RingGeometry(4, 5, 32);
            const ringMat = new THREE.MeshBasicMaterial({
                color: isYours ? 0x00ff00 : 0xff0066,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide
            });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.position.set(x, y, z);
            ring.lookAt(0, 0, 0);
            scene.add(ring);
            pulseMarkers.push(ring);
        }

        function requestLocation() {
            const permEl = document.getElementById('locationPermission');
            if (navigator.geolocation) {
                permEl.style.display = 'block';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        permEl.style.display = 'none';
                    },
                    (error) => {
                        console.log('Location denied, using random location');
                        userLocation = {
                            lat: (Math.random() - 0.5) * 180,
                            lon: (Math.random() - 0.5) * 360
                        };
                        permEl.style.display = 'none';
                    }
                );
            }
        }

        function sendPulse() {
            if (!socket || !socket.connected) {
                alert('Not connected to server. Please refresh the page.');
                return;
            }

            pulseBtn.classList.add('pulsing');
            setTimeout(() => pulseBtn.classList.remove('pulsing'), 600);

            const timestamp = Date.now();
            const location = userLocation || {
                lat: (Math.random() - 0.5) * 180,
                lon: (Math.random() - 0.5) * 360
            };

            socket.emit('sendPulse', {
                timestamp: timestamp,
                lat: location.lat,
                lon: location.lon
            });

            navigator.vibrate && navigator.vibrate(200);
        }

        function initSocket() {
            socket = io(SOCKET_URL, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                console.log('‚úÖ Connected to server');
                document.querySelector('.connection-status').style.background = 'rgba(76, 175, 80, 0.3)';
                socket.emit('requestRecentPulses');
            });

            socket.on('disconnect', () => {
                console.log('‚ùå Disconnected from server');
                document.querySelector('.connection-status').style.background = 'rgba(244, 67, 54, 0.3)';
            });

            socket.on('recentPulses', (pulses) => {
                pulseHistory = pulses.map(p => ({
                    id: p._id,
                    timestamp: p.timestamp,
                    lat: p.lat,
                    lon: p.lon,
                    isYours: false
                }));

                yourPulsesCount = pulseHistory.filter(p => p.isYours).length;
                globalPulsesCount = pulseHistory.length;
                
                yourPulsesEl.textContent = yourPulsesCount;
                globalPulsesEl.textContent = globalPulsesCount;
                
                updateTimeline();
                updateSynchronizedMomentsList();
            });

            socket.on('newPulse', (pulse) => {
                pulseHistory.push(pulse);
                globalPulsesCount++;
                globalPulsesEl.textContent = globalPulsesCount;
                addPulseToGlobe(pulse.lat, pulse.lon, false);
                updateTimeline();
                checkSynchronizedMoments(pulse.timestamp);
            });

            socket.on('pulseConfirmed', (pulse) => {
                yourPulsesCount++;
                globalPulsesCount++;
                yourPulsesEl.textContent = yourPulsesCount;
                globalPulsesEl.textContent = globalPulsesCount;

                pulseHistory.push(pulse);
                addPulseToGlobe(pulse.lat, pulse.lon, true);
                updateTimeline();
                checkSynchronizedMoments(pulse.timestamp);
            });

            socket.on('userCount', (count) => {
                connectedUsersEl.textContent = count;
            });

            socket.on('error', (message) => {
                console.error('Server error:', message);
            });
        }

        function updateTimeline() {
            const now = Date.now();
            const oneMinute = 60000;
            
            timelineBuckets = new Array(60).fill(0);
            
            pulseHistory.forEach(pulse => {
                const minutesAgo = Math.floor((now - pulse.timestamp) / oneMinute);
                if (minutesAgo < 60) {
                    const index = 59 - minutesAgo;
                    timelineBuckets[index]++;
                }
            });

            timelineGraphEl.innerHTML = '';
            const maxCount = Math.max(...timelineBuckets, 1);
            
            timelineBuckets.forEach((count, index) => {
                const bar = document.createElement('div');
                bar.className = 'timeline-bar';
                bar.style.left = `${(index / 60) * 100}%`;
                bar.style.height = `${(count / maxCount) * 170}px`;
                bar.title = `${count} pulses`;
                timelineGraphEl.appendChild(bar);
            });
        }

        function checkSynchronizedMoments(newTimestamp) {
            const timeWindow = 60000;
            const syncThreshold = 2;
            
            const recentPulses = pulseHistory.filter(p => 
                Math.abs(p.timestamp - newTimestamp) < timeWindow
            );

            if (recentPulses.length >= syncThreshold) {
                const momentId = `moment_${Math.floor(newTimestamp / timeWindow)}`;
                updateSynchronizedMomentsList();
                
                const yourSyncedCount = pulseHistory.filter(p => 
                    p.isYours && recentPulses.some(rp => 
                        Math.abs(rp.timestamp - p.timestamp) < timeWindow && rp.id !== p.id
                    )
                ).length;
                peopleSyncedEl.textContent = yourSyncedCount;
            }
        }

        function updateSynchronizedMomentsList() {
            const timeWindow = 60000;
            const moments = {};
            
            pulseHistory.forEach(pulse => {
                const bucketKey = Math.floor(pulse.timestamp / timeWindow);
                if (!moments[bucketKey]) {
                    moments[bucketKey] = [];
                }
                moments[bucketKey].push(pulse);
            });

            const syncedMoments = Object.entries(moments)
                .filter(([key, pulses]) => pulses.length >= 2)
                .sort(([a], [b]) => b - a)
                .slice(0, 20);

            if (syncedMoments.length === 0) {
                syncedMomentsEl.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px; font-size: 0.9em;">No synchronized moments yet</div>';
                return;
            }

            syncedMomentsEl.innerHTML = syncedMoments.map(([bucketKey, pulses]) => {
                const momentTime = new Date(parseInt(bucketKey) * timeWindow);
                const hasYourPulse = pulses.some(p => p.isYours);
                const locationStr = pulses.slice(0, 3).map(p => 
                    p.isYours ? 'You' : `${p.lat.toFixed(1)}¬∞, ${p.lon.toFixed(1)}¬∞`
                ).join(', ');
                
                return `
                    <div class="moment-item" data-moment-id="${bucketKey}">
                        <div class="moment-time">${momentTime.toLocaleTimeString()}</div>
                        <div class="moment-count">${pulses.length} people ${hasYourPulse ? '(including you)' : ''}</div>
                        <div class="moment-locations">${locationStr}${pulses.length > 3 ? '...' : ''}</div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.moment-item').forEach(item => {
                item.addEventListener('click', () => {
                    const momentId = item.dataset.momentId;
                    highlightMoment(momentId);
                });
            });
        }

        function highlightMoment(momentId) {
            document.querySelectorAll('.moment-item').forEach(item => {
                item.classList.toggle('active', item.dataset.momentId === momentId);
            });

            const timeWindow = 60000;
            const momentPulses = pulseHistory.filter(p => 
                Math.floor(p.timestamp / timeWindow) === parseInt(momentId)
            );

            scene.children.filter(obj => obj instanceof THREE.Mesh && obj !== globe).forEach(obj => {
                scene.remove(obj);
            });
            pulseMarkers = [];

            momentPulses.forEach(pulse => {
                addPulseToGlobe(pulse.lat, pulse.lon, pulse.isYours);
            });

            activeMomentId = momentId;
        }

        pulseBtn.addEventListener('click', sendPulse);

        initGlobe();
        initSocket();
        requestLocation();
        
        setInterval(updateTimeline, 5000);
    </script>
</body>
</html>